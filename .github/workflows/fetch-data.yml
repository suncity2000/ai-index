name: Fetch AI Data

on:
  schedule:
    # 매일 한국시간 오전 9시 15분 (UTC 00:15)
    # 00:00 UTC는 가장 혼잡한 시간대로 지연이 심함. 15분으로 변경하여 지연 완화
    - cron: '15 0 * * *'
  workflow_dispatch: # 수동 실행 가능

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create data directory if not exists
        run: mkdir -p data data/history

      - name: Backup previous day data to history
        run: |
          # Calculate yesterday's date (the date of the data we're backing up)
          YESTERDAY=$(date -u -d "yesterday" +"%Y-%m-%d")
          if [ -f data/llms.json ]; then
            cp data/llms.json data/history/${YESTERDAY}-llms.json
            cp data/text-to-image.json data/history/${YESTERDAY}-text-to-image.json 2>/dev/null || true
            cp data/text-to-speech.json data/history/${YESTERDAY}-text-to-speech.json 2>/dev/null || true
            cp data/text-to-video.json data/history/${YESTERDAY}-text-to-video.json 2>/dev/null || true
            cp data/image-to-video.json data/history/${YESTERDAY}-image-to-video.json 2>/dev/null || true
            echo "Backed up data for ${YESTERDAY}"
          else
            echo "No previous data to backup"
          fi

      - name: Clean old history (keep last 7 days)
        run: |
          find data/history -name "*.json" -type f -mtime +7 -delete 2>/dev/null || true
          echo "Cleaned old history files"

      - name: Fetch LLM data
        run: |
          curl --retry 3 --retry-delay 5 --fail --show-error --silent \
               -H "X-API-Key: ${{ secrets.AI_MODELS_KEY }}" \
               -o data/llms.json \
               https://artificialanalysis.ai/api/v2/data/llms/models

      - name: Fetch Text-to-Image data
        run: |
          curl --retry 3 --retry-delay 5 --fail --show-error --silent \
               -H "X-API-Key: ${{ secrets.AI_MODELS_KEY }}" \
               -o data/text-to-image.json \
               https://artificialanalysis.ai/api/v2/data/media/text-to-image

      - name: Fetch Text-to-Speech data
        run: |
          curl --retry 3 --retry-delay 5 --fail --show-error --silent \
               -H "X-API-Key: ${{ secrets.AI_MODELS_KEY }}" \
               -o data/text-to-speech.json \
               https://artificialanalysis.ai/api/v2/data/media/text-to-speech

      - name: Fetch Text-to-Video data
        run: |
          curl --retry 3 --retry-delay 5 --fail --show-error --silent \
               -H "X-API-Key: ${{ secrets.AI_MODELS_KEY }}" \
               -o data/text-to-video.json \
               https://artificialanalysis.ai/api/v2/data/media/text-to-video

      - name: Fetch Image-to-Video data
        run: |
          curl --retry 3 --retry-delay 5 --fail --show-error --silent \
               -H "X-API-Key: ${{ secrets.AI_MODELS_KEY }}" \
               -o data/image-to-video.json \
               https://artificialanalysis.ai/api/v2/data/media/image-to-video

      - name: Update timestamp
        run: |
          echo "{\"last_updated\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\"}" > data/last-updated.json

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/*.json data/history/*.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update AI data $(date -u +"%Y-%m-%d %H:%M UTC")" && git push origin master)
